<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daftar Kamar - Sigura Kost</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/styleKost.css">

</head>
<body>
    <%- include('layout/navbar')  %>
    <!-- Main Content -->
    <main>
        <div class="page-header">
            <% if (user) { %>
                <h1 class="page-title">Selamat Datang, <%= user.username %></h1>
            <% } else { %>
                <h1 class="page-title">Daftar Kamar</h1>
            <% } %>
        </div>

        <div id="kamar" class="room-grid">
    <% kamar.forEach(k => { %>
        <div class="room-card" 
             data-id="<%= k._id %>"
             data-nama="<%= k.namaKamar %>"
             data-harga="<%= k.harga %>"
             data-deskripsi="<%= k.deskripsi %>"
             data-status="<%= k.status %>"
             data-gambar="<%= k.gambar %>"
             data-tipe="<%= k.tipeKamar %>"
             data-luas="<%= k.luasKamar %>"
             data-kapasitas="<%= k.kapasitas %>"
             data-galeri="<%= k.galeri && k.galeri.length > 0 ? k.galeri.map(g => '' + g.foto).join(',') : '' %>"
             data-telepon="<%= k.teleponPemilik %>"
             data-alamat="<%= k.alamatKost %>">

            <div class="room-image" style="background-image: url('<%= k.gambar %>')">
                <div class="room-status 
                    <%= k.status === "kosong" ? "status-available" : "status-occupied" %>">
                    <%= k.status %>
                </div>
            </div>
            
            <div class="room-content">
                <h2 class="room-number"><%= k.namaKamar %></h2>
                    <div class="room-price">
                        <strong>Harga:</strong> Rp <%= k.harga.toLocaleString('id-ID') %> / bulan
                    </div>
                <p><%= k.alamatKost %></p>
                    <% if (user) { %>
                        <button class="btn-delete-card" data-kost-id="<%= k._id %>">
                            <i class="fas fa-trash"></i> Hapus Kamar
                        </button>
                    <% } %>
            </div>
        </div>
    <% }) %>

</div>


    </main>
         
    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-box">
            <button class="modal-close">✕</button>
            <div class="modal-content">
                <!-- Modal content will be dynamically generated here -->
            </div>
        </div>
    </div>

    <script>
        let currentSlide = 0;
        let slides = [];
        let dots = [];

        function moveSlide(n) {
            goToSlide(currentSlide + n);
        }

        function goToSlide(n) {
            if (n >= slides.length) currentSlide = 0;
            else if (n < 0) currentSlide = slides.length - 1;
            else currentSlide = n;

            slides.forEach(slide => slide.classList.remove('active'));
            dots.forEach(dot => dot.classList.remove('active'));

            if (slides[currentSlide]) slides[currentSlide].classList.add('active');
            if (dots[currentSlide]) dots[currentSlide].classList.add('active');
            
            const counter = document.querySelector('#slide-counter');
            if (counter) counter.textContent = currentSlide + 1;
        }

        document.addEventListener("DOMContentLoaded", () => {
            const cards = document.querySelectorAll(".room-card");
            const modal = document.getElementById("modal");
            const modalContent = modal.querySelector(".modal-content");
            const closeBtn = modal.querySelector(".modal-close");

            cards.forEach(card => {
                card.addEventListener("click", () => {
                    const nama = card.dataset.nama;
                    const harga = card.dataset.harga;
                    const deskripsi = card.dataset.deskripsi;
                    const status = card.dataset.status;
                    const gambar = card.dataset.gambar;
                    const tipe = card.dataset.tipe;
                    const luas = card.dataset.luas;
                    const kapasitas = card.dataset.kapasitas;
                    const galeri = card.dataset.galeri ? card.dataset.galeri.split(',').filter(g => g) : [];
                    const telepon = card.dataset.telepon;
                    const alamat = card.dataset.alamat;

                    // Reset carousel
                    currentSlide = 0;

                    // Build carousel HTML
                    let carouselHTML = `
                        <div class="carousel-container" id="carousel">
                            <div class="carousel-slide active" style="background-image: url('${gambar}')"></div>
                    `;
                    
                    galeri.forEach((img, idx) => {
                        carouselHTML += `<div class="carousel-slide" style="background-image: url('${img}')"></div>`;
                    });

                    const totalSlides = galeri.length + 1;
                    
                    if (totalSlides > 1) {
                        carouselHTML += `
                            <button class="carousel-prev" onclick="moveSlide(-1)">❮</button>
                            <button class="carousel-next" onclick="moveSlide(1)">❯</button>
                            <div class="carousel-counter"><span id="slide-counter">1</span>/${totalSlides}</div>
                            <div class="carousel-dots">
                        `;
                        for (let i = 0; i < totalSlides; i++) {
                            carouselHTML += `<button class="carousel-dot ${i === 0 ? 'active' : ''}" onclick="goToSlide(${i})"></button>`;
                        }
                        carouselHTML += `</div>`;
                    }
                    
                    carouselHTML += `</div>`;

                    modalContent.innerHTML = `
                        ${carouselHTML}
                        <h2 class="modal-title">${nama}</h2>

                        <div class="modal-details">
                            <div class="detail-item">
                                <span class="detail-label">Tipe Kamar:</span>
                                <span class="detail-value">${tipe || "-"}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Kapasitas:</span>
                                <span class="detail-value">${kapasitas} orang</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Luas Kamar:</span>
                                <span class="detail-value">${luas} m²</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Status:</span>
                                <span class="detail-value ${status === 'kosong' ? 'status-kosong' : ''}">${status}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Harga:</span>
                                <span class="detail-value">Rp ${parseInt(harga).toLocaleString('id-ID')} / bulan</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Telepon Pemilik:</span>
                                <span class="detail-value"><a href="https://wa.me/${telepon || "-"}">${telepon || "-"}</a></span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Alamat Kost:</span>
                                <span class="detail-value">${alamat || "-"}</span>
                            </div>
                        </div>

                        <div>
                            <h3>Deskripsi Kamar</h3>
                            <p>${deskripsi || "Tidak ada deskripsi."}</p>
                        </div>

                        <div class="modal-actions">
                            <% if (typeof user !== 'undefined' && user) { %>
                                <button class="btn btn-primary" id="editBtn">Edit</button>
                                <button class="btn" id="deleteBtn">Hapus</button>
                            <% } else { %>
                                <button class="btn btn-primary">Pesan Sekarang</button>
                            <% } %>

                            <button class="btn btn-secondary tutup-modal">Tutup</button>
                            <% if (!user) { %>
                            <button class="btn" id="waBtn">
                                <i class="fab fa-whatsapp"></i> Hubungi Pemilik
                            </button>
                            <% } %>
                            
                        </div>
                    `;

                    // Update carousel references
                    slides = modalContent.querySelectorAll('.carousel-slide');
                    dots = modalContent.querySelectorAll('.carousel-dot');

                    // Handle Edit button untuk admin
                    const editBtn = modalContent.querySelector('#editBtn');
                    if (editBtn) {
                        editBtn.addEventListener('click', () => {
                            window.location.href = `/kost/edit/${card.dataset.id}`;
                        });
                    }

                    // Handle Delete button untuk admin
                    const deleteBtn = modalContent.querySelector('#deleteBtn');
                    if (deleteBtn) {
                        deleteBtn.addEventListener('click', () => {
                            if (confirm('Yakin ingin menghapus kamar ini? Semua galeri juga akan dihapus.')) {
                                fetch(`/kost/delete/${card.dataset.id}`, {
                                    method: 'DELETE'
                                })
                                .then(response => {
                                    if (response.ok) {
                                        alert('Kamar berhasil dihapus');
                                        window.location.href = '/kost';
                                    } else {
                                        alert('Gagal menghapus kamar');
                                    }
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                                    alert('Terjadi kesalahan');
                                });
                            }
                        });
                    }

                    // Handle WhatsApp button
                    const waBtn = modalContent.querySelector('#waBtn');
                    if (waBtn) {
                        waBtn.addEventListener('click', () => {
                            const phoneNumber = telepon.replace(/\D/g, '');
                            const message = encodeURIComponent(
        `PERMISI KAK,
SAYA CUSTOMER SIGURA KOST

SAYA TERTARIK DENGAN KAMAR ${nama}
APAKAH SAYA DAPAT BERTANYA SOAL KAMAR TERSEBUT??

TERIMAKASIH`
                            );
                            window.open(`https://wa.me/${phoneNumber}?text=${message}`, '_blank');
                        });
                    }

                    // Tambahkan event listener untuk tombol tutup di dalam modal
                    const tutupBtn = modalContent.querySelector('.tutup-modal');
                    if (tutupBtn) {
                        tutupBtn.addEventListener('click', () => {
                            modal.classList.remove('active');
                        });
                    }

                    modal.classList.add("active");
                });
            });

            closeBtn.addEventListener("click", () => {
                modal.classList.remove("active");
            });

            modal.addEventListener("click", (e) => {
                if (e.target === modal) modal.classList.remove("active");
            });

            // Handle delete button di card
            document.querySelectorAll('.btn-delete-card').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const kostId = btn.dataset.kostId;
                    
                    if (confirm('Yakin ingin menghapus kamar ini? Semua galeri juga akan dihapus.')) {
                        fetch(`/kost/delete/${kostId}`, {
                            method: 'DELETE'
                        })
                        .then(response => {
                            if (response.ok) {
                                alert('Kamar berhasil dihapus');
                                window.location.href = '/kost';
                            } else {
                                alert('Gagal menghapus kamar');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('Terjadi kesalahan');
                        });
                    }
                });
            });
        });
    </script>
</body>
</html>